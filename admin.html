<!DOCTYPE html>
<html>
<head>
    <title>The Town Tote - Admin Login</title>
    <!-- Add your Firebase SDK scripts here, just like you did for the main lottery page! -->
    <!-- Usually something like this, but ensure you have your project's config! -->
    <script type="module">
        import { getFirestore, collection, query, where, getDocs, doc, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js'; // Ensure this matches your Firebase SDK version
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js"; // Replace 10.x.x with your version
      import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js"; // Replace 10.x.x with your version
      // Your web app's Firebase configuration
      // THIS IS CRUCIAL! You'll find this in your Firebase Project Settings -> General -> Your apps -> Firebase SDK snippet -> Config
      const firebaseConfig = {
        apiKey: "AIzaSyCnCEdhJBRIOwLP_IkviuVFaIrHXHDW7ko",
        authDomain: "the-town-tote.firebaseapp.com",
        databaseURL: "https://the-town-tote-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "the-town-tote",
        storageBucket: "the-town-tote.firebasestorage.app",
        messagingSenderId: "621734345222",
        appId: "1:621734345222:web:d49cad8ff26f84e7866187"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app); // Get the authentication service
const db = getFirestore(app); // NEW: Initialize Firestore
        // --- Function to calculate the CURRENT draw's time window for live count ---
function getCurrentDrawWindow() {
    const now = new Date(); // Use the actual current time for the live count
    now.setSeconds(0, 0); // Ignore seconds and milliseconds for comparison precision

    let currentPeriodStart;
    let currentPeriodEnd;

    // 1. Calculate the START of the current selling period (most recent Sunday 22:00)
    let lastSunday22h = new Date(now);
    lastSunday22h.setDate(now.getDate() - now.getDay()); // Go to this Sunday (00:00)
    lastSunday22h.setHours(22, 0, 0, 0);

    // If 'now' is currently before this Sunday's 22:00 (e.g., it's Friday, or Sunday before 22:00),
    // then the current selling period started last Sunday at 22:00.
    if (now.getTime() < lastSunday22h.getTime()) {
        lastSunday22h.setDate(lastSunday22h.getDate() - 7); // Go back to last Sunday 22:00
    }
    currentPeriodStart = lastSunday22h;

    // 2. Calculate the END of the current selling period (next Sunday 17:00 from the start)
    currentPeriodEnd = new Date(currentPeriodStart);
    currentPeriodEnd.setDate(currentPeriodStart.getDate() + 7); // Next Sunday
    currentPeriodEnd.setHours(17, 0, 0, 0); // At 17:00

    // 3. Check for the "gap" period (Sunday 17:00 to Sunday 22:00)
    // If 'now' is on a Sunday AND between the 'currentPeriodEnd' (17:00) and 'currentPeriodStart' of the NEXT cycle (22:00)
    if (now.getDay() === 0 && now.getTime() >= currentPeriodEnd.getTime() && now.getTime() < currentPeriodStart.getTime() + (5 * 60 * 60 * 1000)) {
        // This means it's Sunday, and we're in the 17:00-22:00 gap. No active selling period.
        console.log("Current selling period: No active period (gap)");
        return null; // Indicate no active period
    }

    console.log("Current selling period:");
    console.log("Start:", currentPeriodStart.toLocaleString());
    console.log("End:", currentPeriodEnd.toLocaleString());

    return {
        startTime: currentPeriodStart,
        endTime: currentPeriodEnd
    };
}
        // Variable to hold the unsubscribe function for the live listener
let unsubscribeLiveCount = null;

// --- Function to set up the live entry count ---
window.setupLiveEntryCount = () => {
    const countDisplay = document.getElementById('current-entries-count');
    const periodDisplay = document.getElementById('current-entries-period');

    // First, if there's an existing listener, unsubscribe it to avoid duplicates
    if (unsubscribeLiveCount) {
        unsubscribeLiveCount();
        console.log("Unsubscribed from previous live count listener.");
    }

    const currentWindow = getCurrentDrawWindow();

    if (currentWindow === null) { // If we are in the gap period
        countDisplay.textContent = '0 (Sales Closed)';
        periodDisplay.textContent = 'Next sales open: ' + new Date(getCurrentDrawWindow().startTime).toLocaleString() + ' to ' + new Date(getCurrentDrawWindow().endTime).toLocaleString();
        return;
    }

    const entriesRef = collection(db, "lottery_entries");
    const q = query(
        entriesRef,
        where("timestamp", ">=", currentWindow.startTime),
        where("timestamp", "<=", currentWindow.endTime)
    );

    // Set up the real-time listener!
    unsubscribeLiveCount = onSnapshot(q, (querySnapshot) => {
        const count = querySnapshot.size; // Get the number of documents matching the query
        countDisplay.textContent = count; // Update the HTML
        periodDisplay.textContent = `${currentWindow.startTime.toLocaleString()} to ${currentWindow.endTime.toLocaleString()}`;
        console.log(`Live count: ${count} entries for the current period.`);
    }, (error) => {
        console.error("Error setting up live listener:", error);
        countDisplay.textContent = 'Error!';
        periodDisplay.textContent = 'Failed to load period.';
    });
};
        // --- Function to calculate the previous draw's time window ---
function getPreviousDrawWindow() {
  const now = new Date(); // What time is it right now?

  // Calculate the CLOSING time for the *last* draw period (Sunday 5 PM)
  let closingDateOfLastDraw = new Date(now);
  closingDateOfLastDraw.setHours(17, 0, 0, 0); // Set to 5 PM

  // Adjust to find the correct previous Sunday 5 PM close
  if (now.getDay() === 0 && now.getHours() >= 17) {
    // If it's Sunday and after 5 PM, the current draw just closed.
    // The previous one closed last Sunday.
    closingDateOfLastDraw.setDate(now.getDate() - 7); // Go back one week
  } else {
    // If not Sunday after 5 PM, the previous draw closed on the last Sunday.
    // Go back to the most recent Sunday (0 for Sunday, 1 for Monday, etc.)
    closingDateOfLastDraw.setDate(now.getDate() - (now.getDay() === 0 ? 7 : now.getDay()));
  }
  closingDateOfLastDraw.setHours(17, 0, 0, 0); // Ensure it's 5 PM on that Sunday

  // Calculate the OPENING time for that same draw window (Sunday 10 PM, 7 days before closing)
  let openingDateOfLastDraw = new Date(closingDateOfLastDraw);
  openingDateOfLastDraw.setDate(openingDateOfLastDraw.getDate() - 7); // Go back one week
  openingDateOfLastDraw.setHours(22, 0, 0, 0); // Set it to 10 PM (22:00)

  console.log("Searching for tickets from:");
  console.log("Start:", openingDateOfLastDraw.toLocaleString());
  console.log("End:", closingDateOfLastDraw.toLocaleString());

  return {
    startTime: openingDateOfLastDraw,
    endTime: closingDateOfLastDraw
  };
}

// --- Function to fetch and display lottery entries ---
window.fetchAndDisplayLottery_entries = async () => {
  const displayElement = document.getElementById('lottery-entries-display');
  displayElement.innerHTML = 'Loading entries...'; // Show loading message

  const { startTime, endTime } = getPreviousDrawWindow(); // Get our time window

  const entriesRef = collection(db, "lottery_entries"); // Your collection name

  const q = query(
    entriesRef,
    where("timestamp", ">=", startTime),
    where("timestamp", "<=", endTime)
  );

  try {
    const querySnapshot = await getDocs(q);
    const entries = [];
    querySnapshot.forEach((doc) => {
      entries.push({ id: doc.id, ...doc.data() });
    });

    if (entries.length === 0) {
      displayElement.innerHTML = '<p>No lottery entries found for the previous draw period.</p>';
      return;
    }

    // --- Display the entries in a table ---
    let html = `
      <p>Found <strong>${entries.length}</strong> entries for the period: <br>
      ${startTime.toLocaleString()} to ${endTime.toLocaleString()}</p>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Numbers</th>
            <th>Method</th>
            <th>Timestamp</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
    `;

    entries.forEach(entry => {
      // Format numbers nicely, e.g., [1, 5, 12, 23] becomes "01, 05, 12, 23"
      const formattedNumbers = entry.selectedNumbers ?
        entry.selectedNumbers.map(n => String(n).padStart(2, '0')).join(', ') : 'N/A';
      
      const entryDate = entry.timestamp ? 
        new Date(entry.timestamp.toDate()).toLocaleString() : 'N/A'; // Convert Firestore Timestamp to Date

      html += `
        <tr>
          <td>${entry.name || 'N/A'}</td>
          <td>${entry.email || 'N/A'}</td>
          <td>${formattedNumbers}</td>
          <td>${entry.selectionMethod || 'N/A'}</td>
          <td>${entryDate}</td>
          <td>
            <button onclick="deleteLotteryEntry('${entry.id}')">Delete</button>
          </td>
        </tr>
      `;
    });

    html += `
        </tbody>
      </table>
      <style> /* Basic styling for the table */
        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
        }
        th, td {
          border: 1px solid #ddd;
          padding: 8px;
          text-align: left;
        }
        th {
          background-color: #f2f2f2;
        }
        tr:nth-child(even) {
          background-color: #f9f9f9;
        }
        button {
          padding: 5px 10px;
          cursor: pointer;
        }
      </style>
    `;
    displayElement.innerHTML = html;

  } catch (error) {
    console.error("Error fetching lottery entries:", error);
    displayElement.innerHTML = '<p>Error loading entries. Please check the console for details.</p>';
  }
};

// --- Function to delete a lottery entry (will be called by buttons) ---
window.deleteLotteryEntry = async (entryId) => {
  if (!confirm("Are you sure you want to delete this entry?")) {
    return; // User cancelled
  }
  try {
    await deleteDoc(doc(db, "lottery_entries", entryId));
    console.log("Document successfully deleted!", entryId);
    // Refresh the list after deletion
    window.fetchAndDisplayLottery_entries();
  } catch (error) {
    console.error("Error removing document: ", error);
    alert("Error deleting entry: " + error.message);
  }
};
      // --- This is the part that watches for sign-in/sign-out ---
      onAuthStateChanged(auth, (user) => {
        const loginSection = document.getElementById('login-section');
        const adminContent = document.getElementById('admin-content');
        const messageDisplay = document.getElementById('message');

        if (user) {
          // User is signed in!
          messageDisplay.innerHTML = `Welcome, ${user.email}! You are signed in.`;
          loginSection.style.display = 'none'; // Hide login form
          adminContent.style.display = 'block'; // Show admin dashboard
          window.fetchAndDisplayLottery_entries();
          window.setupLiveEntryCount(); // NEW: Start the live count listener!  
        } else {
          // User is signed out or not signed in.
          messageDisplay.innerHTML = 'Please sign in to access the admin panel.';
          loginSection.style.display = 'block'; // Show login form
          adminContent.style.display = 'none'; // Hide admin dashboard
        }
      });

      // --- This is the part that handles the sign-in button click ---
      window.handleSignIn = async () => { // Make this function globally accessible
        const emailInput = document.getElementById('email').value;
        const passwordInput = document.getElementById('password').value;
        const messageDisplay = document.getElementById('message');

        try {
          messageDisplay.innerHTML = 'Signing in...';
          const userCredential = await signInWithEmailAndPassword(auth, emailInput, passwordInput);
          // If successful, onAuthStateChanged will handle displaying content
          console.log("Signed in user:", userCredential.user.email);
          // No need to redirect here, onAuthStateChanged takes care of it.
        } catch (error) {
          // If there's an error (e.g., wrong password, user not found)
          const errorCode = error.code;
          const errorMessage = error.message;
          messageDisplay.innerHTML = `Error: ${errorMessage}`;
          console.error("Sign-in error:", errorCode, errorMessage);
        }
      };

      // Optional: Add a sign-out button
      window.handleSignOut = async () => {
        try {
          await auth.signOut();
          console.log("User signed out.");
            if (unsubscribeLiveCount) {
              unsubscribeLiveCount();
              unsubscribeLiveCount = null; // Clear the variable
              console.log("Unsubscribed from live count listener on sign-out.");
          }
          // onAuthStateChanged will detect this and show the login form again
        } catch (error) {
          console.error("Sign-out error:", error);
        }
          // ... (your existing Firebase SDK imports and initializations) ...
      };
// ... (your existing window.handleSignIn and window.handleSignOut functions) ...
    </script>
</head>
<body>

    <h1>The Town Tote - Admin Panel</h1>

    <!-- Section for login form -->
    <div id="login-section">
        <h2>Admin Login</h2>
        <p id="message">Please sign in to access the admin panel.</p>
        <div>
            <label for="email">Email:</label><br>
            <input type="email" id="email" placeholder="admin@example.com"><br><br>
        </div>
        <div>
            <label for="password">Password:</label><br>
            <input type="password" id="password" placeholder="your_secret_password"><br><br>
        </div>
        <button onclick="handleSignIn()">Sign In</button>
    </div>

    <!-- Section for admin content (only visible when signed in) -->
    <div id="admin-content" style="display: none;">
        <h2>Welcome to the Admin Dashboard!</h2>
        <!-- This is where all your viewing/deleting/searching code will go -->
        <p>This content is only visible to signed-in admins.</p>
        <button onclick="handleSignOut()">Sign Out</button>
        
        <h3>Current Week's Entries: <span id="current-entries-count">Loading...</span></h3>
        <p>Period: <span id="current-entries-period">Calculating...</span></p>
        
        <!-- Placeholder for where you'll display lottery entries -->
        <h3>Lottery Entries for Last Draw:</h3>
        <div id="lottery-entries-display">
            <!-- Your entries will be loaded here by JavaScript -->
            Loading entries...
        </div>

        <!-- Placeholder for winning number search -->
        <h3>Find Winners:</h3>
        <p>Enter 4 winning numbers (e.g., 1,5,12,23):</p>
        <input type="text" id="winning-numbers-input" placeholder="e.g., 1, 5, 12, 23">
        <button onclick="findAndDisplayWinners()">Search Winners</button>
        <div id="winning-results-display">
            <!-- Winners will be displayed here -->
        </div>

    </div>

</body>
</html>
